{% extends 'base.html' %}
{% load static %}

{% block title %}Mapa de Reportes - Monitoreo Calles BAQ{% endblock %}

{% block extra_css %}
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    #map {
        width: 100%;
        height: calc(100vh - 56px);
        z-index: 1;
    }

    .custom-marker {
        background: none;
        border: none;
    }

    .sidebar-mapa {
        height: calc(100vh - 56px);
        overflow-y: auto;
        background-color: #f8f9fa;
    }

    .leaflet-popup-content-wrapper {
        border-radius: 8px;
    }
    
    @keyframes ping {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.3);
            opacity: 0.7;
        }
    }
</style>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
{% endblock %}

{% block main_class %}container-fluid p-0{% endblock %}

{% block content %}
<div class="row g-0">
    <!-- Sidebar con filtros -->
    <div class="col-lg-3 sidebar-mapa">
        <div class="p-3">
            <h5 class="mb-3"><i class="bi bi-funnel"></i> Filtros</h5>

            <div class="mb-3">
                <label class="form-label fw-bold">Estado</label>
                <select class="form-select" id="filtroEstado" onchange="aplicarFiltrosMapa()">
                    <option value="">Todos</option>
                    <option value="Nuevo">Nuevo</option>
                    <option value="En Revisión">En Revisión</option>
                    <option value="Asignado">Asignado</option>
                    <option value="En Proceso">En Proceso</option>
                    <option value="Resuelto">Resuelto</option>
                    <option value="Rechazado">Rechazado</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Prioridad</label>
                <select class="form-select" id="filtroPrioridad" onchange="aplicarFiltrosMapa()">
                    <option value="">Todas</option>
                    <option value="Baja">Baja</option>
                    <option value="Media">Media</option>
                    <option value="Alta">Alta</option>
                    <option value="Crítica">Crítica</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Tipo de Falla</label>
                <select class="form-select" id="filtroTipo" onchange="aplicarFiltrosMapa()">
                    <option value="">Todos</option>
                    <option value="bache">Bache o hueco</option>
                    <option value="fisura">Fisura o grieta</option>
                    <option value="hundimiento">Hundimiento de vía</option>
                    <option value="desprendimiento">Desprendimiento</option>
                    <option value="inundacion">Inundación</option>
                    <option value="obstruccion">Obstrucción</option>
                    <option value="otro">Otro</option>
                </select>
            </div>

            <button class="btn btn-secondary w-100 mb-3" onclick="limpiarFiltrosMapa()">
                <i class="bi bi-x-circle"></i> Limpiar Filtros
            </button>

            <hr>

            <h6 class="mb-3"><i class="bi bi-info-circle"></i> Leyenda</h6>
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-geo-alt-fill text-danger me-2" style="font-size: 1.5rem;"></i>
                <small>Crítica</small>
            </div>
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-geo-alt-fill text-warning me-2" style="font-size: 1.5rem;"></i>
                <small>Alta</small>
            </div>
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-geo-alt-fill text-info me-2" style="font-size: 1.5rem;"></i>
                <small>Media</small>
            </div>
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-geo-alt-fill text-secondary me-2" style="font-size: 1.5rem;"></i>
                <small>Baja</small>
            </div>

            {% if user.is_authenticated %}
            <hr>
            {% if user.rol.nombre == 'Ciudadano' %}
            <div class="alert alert-success">
                <i class="bi bi-cursor-fill"></i>
                <strong>Clic en el mapa</strong>
                <p class="mb-0 small mt-2">Haz clic en cualquier punto del mapa para crear un reporte</p>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Información</strong>
                <p class="mb-0 small mt-2">Visualiza todos los reportes del sistema en el mapa</p>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- Mapa -->
    <div class="col-lg-9">
        <div id="map"></div>
    </div>
</div>

<!-- Modal para crear reporte -->
{% if user.is_authenticated and user.rol.nombre == 'Ciudadano' %}
<div class="modal fade" id="modalCrearReporte" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Crear Reporte en esta Ubicación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'reportes:crear_reporte_desde_mapa' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="latitud" id="modal_latitud">
                    <input type="hidden" name="longitud" id="modal_longitud">

                    <div class="alert alert-info">
                        <i class="bi bi-geo-alt-fill"></i>
                        <strong>Ubicación seleccionada:</strong>
                        <p class="mb-0 mt-1" id="direccion_seleccionada">Cargando dirección...</p>
                    </div>

                    <div class="mb-3">
                        <label for="tipo" class="form-label fw-bold">Tipo de falla *</label>
                        <select class="form-select" name="tipo" id="tipo" required>
                            <option value="">Seleccionar...</option>
                            <option value="bache">Bache o hueco</option>
                            <option value="fisura">Fisura o grieta</option>
                            <option value="hundimiento">Hundimiento de vía</option>
                            <option value="desprendimiento">Desprendimiento de capa asfáltica</option>
                            <option value="inundacion">Inundación o encharcamiento</option>
                            <option value="obstruccion">Obstrucción en la calzada</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="titulo" class="form-label fw-bold">Título *</label>
                        <input type="text" class="form-control" name="titulo" id="titulo"
                            placeholder="Ej: Bache profundo en vía principal" required>
                    </div>

                    <div class="mb-3">
                        <label for="descripcion" class="form-label fw-bold">Descripción *</label>
                        <textarea class="form-control" name="descripcion" id="descripcion" rows="4"
                            placeholder="Describe detalladamente el problema..." required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="evidencia" class="form-label fw-bold">Foto o Video (opcional)</label>
                        <input type="file" class="form-control" name="evidencia" id="evidencia" accept="image/*,video/*">
                        <div class="form-text">Sube una foto o video del problema</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Crear Reporte
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<!-- Leaflet MarkerCluster Plugin -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
    // Datos de reportes
    const reportesData = [];
    
    {% for reporte in reportes %}
    {% if reporte.latitud and reporte.longitud %}
    reportesData.push({
        id: {{ reporte.id }},
        lat: parseFloat('{{ reporte.latitud }}'),
        lng: parseFloat('{{ reporte.longitud }}'),
        titulo: '{{ reporte.titulo|escapejs }}',
        descripcion: '{{ reporte.descripcion|truncatewords:20|escapejs }}',
        estado: '{{ reporte.estado.nombre|default:"Sin estado"|escapejs }}',
        prioridad: '{{ reporte.prioridad.nombre|default:"Sin prioridad"|escapejs }}',
        tipo: '{{ reporte.tipo|escapejs }}',
        direccion: '{{ reporte.direccion|escapejs }}',
        fecha: '{{ reporte.reportado_en|date:"d/m/Y H:i" }}',
        url: '{% url "reportes:detalle_reporte" reporte.pk %}'
    });
    {% endif %}
    {% endfor %}

    console.log('Total de reportes cargados:', reportesData.length);
    console.log('Usuario actual:', '{{ user.username }}');
    console.log('Rol actual:', '{{ user.rol.nombre|default:"Sin rol" }}');
    {% if user.rol and user.rol.nombre == 'Ciudadano' %}
    console.log('Es ciudadano?: true');
    {% else %}
    console.log('Es ciudadano?: false');
    {% endif %}

    // Inicializar mapa
    const map = L.map('map').setView([10.9639, -74.7964], 13);

    // Añadir tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // Cluster para marcadores
    const markers = L.markerClusterGroup({
        chunkedLoading: true,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false
    });

    let todosLosMarcadores = [];
    let marcadorTemporal = null;
    let modalInstance = null;

    // Color por prioridad
    function getColorByPriority(prioridad) {
        const p = prioridad.toLowerCase();
        if (p === 'crítica' || p === 'critica') return '#dc3545';
        if (p === 'alta') return '#ffc107';
        if (p === 'media') return '#0dcaf0';
        if (p === 'baja') return '#6c757d';
        return '#0d6efd';
    }

    // Icono personalizado
    function getCustomIcon(prioridad) {
        const color = getColorByPriority(prioridad);
        return L.divIcon({
            html: '<i class="bi bi-geo-alt-fill" style="color: ' + color + '; font-size: 2rem;"></i>',
            className: 'custom-marker',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        });
    }

    // Crear marcadores
    reportesData.forEach(function(reporte) {
        const icon = getCustomIcon(reporte.prioridad);
        const marker = L.marker([reporte.lat, reporte.lng], { icon: icon });
        
        const popup = '<div style="min-width: 250px;">' +
            '<h6 class="mb-2"><strong>' + reporte.titulo + '</strong></h6>' +
            '<p class="mb-1 small">' + reporte.descripcion + '</p>' +
            '<hr class="my-2">' +
            '<p class="mb-1 small"><strong>Prioridad:</strong> ' +
            '<span class="badge badge-prioridad-' + reporte.prioridad.toLowerCase() + '">' + reporte.prioridad + '</span></p>' +
            '<p class="mb-1 small"><strong>Estado:</strong> ' +
            '<span class="badge badge-estado-' + reporte.estado.toLowerCase().replace(' ', '') + '">' + reporte.estado + '</span></p>' +
            '<p class="mb-1 small"><i class="bi bi-geo-alt"></i> ' + reporte.direccion + '</p>' +
            '<p class="mb-2 small text-muted"><i class="bi bi-calendar"></i> ' + reporte.fecha + '</p>' +
            '<a href="' + reporte.url + '" class="btn btn-primary btn-sm w-100"><i class="bi bi-eye"></i> Ver Detalles</a>' +
            '</div>';
        
        marker.bindPopup(popup);
        marker.reporteData = reporte;
        todosLosMarcadores.push(marker);
        markers.addLayer(marker);
    });

    map.addLayer(markers);

    // Funciones auxiliares
    function limpiarFormulario() {
        const tipoEl = document.getElementById('tipo');
        const tituloEl = document.getElementById('titulo');
        const descripcionEl = document.getElementById('descripcion');
        const evidenciaEl = document.getElementById('evidencia');
        const direccionEl = document.getElementById('direccion_seleccionada');
        
        if (tipoEl) tipoEl.value = '';
        if (tituloEl) tituloEl.value = '';
        if (descripcionEl) descripcionEl.value = '';
        if (evidenciaEl) evidenciaEl.value = '';
        if (direccionEl) direccionEl.innerHTML = 'Cargando dirección...';
    }

    function eliminarMarcadorTemporal() {
        if (marcadorTemporal) {
            map.removeLayer(marcadorTemporal);
            marcadorTemporal = null;
        }
    }

    {% if user.is_authenticated and user.rol and user.rol.nombre == 'Ciudadano' %}
    // Clic en mapa para crear reporte (SOLO CIUDADANOS)
    map.on('click', function(e) {
        eliminarMarcadorTemporal();
        
        marcadorTemporal = L.marker([e.latlng.lat, e.latlng.lng], {
            icon: L.divIcon({
                html: '<i class="bi bi-plus-circle-fill" style="color: #198754; font-size: 2.5rem;"></i>',
                className: 'custom-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 40]
            })
        }).addTo(map);
        
        document.getElementById('modal_latitud').value = e.latlng.lat;
        document.getElementById('modal_longitud').value = e.latlng.lng;
        
        limpiarFormulario();
        
        // Obtener dirección
        fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + e.latlng.lat + '&lon=' + e.latlng.lng)
            .then(r => r.json())
            .then(data => {
                document.getElementById('direccion_seleccionada').innerHTML = 
                    '<small>' + (data.display_name || 'Ubicación seleccionada') + '</small>';
            })
            .catch(() => {
                document.getElementById('direccion_seleccionada').innerHTML = 
                    '<small>Lat: ' + e.latlng.lat.toFixed(6) + ', Lng: ' + e.latlng.lng.toFixed(6) + '</small>';
            });
        
        // SOLUCIÓN: Destruir instancia anterior y crear nueva cada vez
        if (modalInstance) {
            modalInstance.dispose();
            modalInstance = null;
        }
        modalInstance = new bootstrap.Modal(document.getElementById('modalCrearReporte'), {
            backdrop: 'static',
            keyboard: true
        });
        modalInstance.show();
    });

    // Eventos del modal - MANTENER SIEMPRE ACTIVO
    const modalElement = document.getElementById('modalCrearReporte');
    
    // Evento al cerrar modal
    modalElement.addEventListener('hidden.bs.modal', function() {
        eliminarMarcadorTemporal();
        limpiarFormulario();
        
        // SOLUCIÓN: Destruir instancia al cerrar pero MANTENER evento de clic activo
        if (modalInstance) {
            modalInstance.dispose();
            modalInstance = null;
        }
    });
    
    // SOLUCIÓN: Manejar botón de cancelar sin destruir el evento de clic
    const btnCancelarModal = modalElement.querySelector('.btn-secondary[data-bs-dismiss="modal"]');
    if (btnCancelarModal) {
        btnCancelarModal.addEventListener('click', function() {
            eliminarMarcadorTemporal();
            limpiarFormulario();
        });
    }
    
    console.log('✅ Sistema de reportes desde mapa activado para ciudadanos');
    {% else %}
    console.log('ℹ️ Modo visualización - Rol:', '{{ user.rol.nombre|default:"Sin rol" }}');
    {% endif %}

    // Filtros
    function aplicarFiltrosMapa() {
        const estado = document.getElementById('filtroEstado').value;
        const prioridad = document.getElementById('filtroPrioridad').value;
        const tipo = document.getElementById('filtroTipo').value;

        markers.clearLayers();
        todosLosMarcadores.forEach(function(marker) {
            const data = marker.reporteData;
            if ((!estado || data.estado === estado) &&
                (!prioridad || data.prioridad === prioridad) &&
                (!tipo || data.tipo === tipo)) {
                markers.addLayer(marker);
            }
        });
    }

    function limpiarFiltrosMapa() {
        document.getElementById('filtroEstado').value = '';
        document.getElementById('filtroPrioridad').value = '';
        document.getElementById('filtroTipo').value = '';
        aplicarFiltrosMapa();
    }

    // Ubicación del usuario
    map.locate({setView: false, maxZoom: 16});
    map.on('locationfound', function(e) {
        L.circle(e.latlng, {
            radius: e.accuracy,
            color: '#0d6efd',
            fillColor: '#0d6efd',
            fillOpacity: 0.2
        }).addTo(map);
        
        L.marker(e.latlng, {
            icon: L.divIcon({
                html: '<i class="bi bi-person-fill" style="color: #0d6efd; font-size: 2rem;"></i>',
                className: 'custom-marker',
                iconSize: [30, 30]
            })
        }).addTo(map).bindPopup("Tu ubicación");
    });

    // Forzar actualización del tamaño del mapa
    setTimeout(function() {
        map.invalidateSize();
    }, 100);
    
    // SOLUCIÓN: Detectar si hay un nuevo reporte y centrarlo
    const urlParams = new URLSearchParams(window.location.search);
    const nuevoReporteId = urlParams.get('nuevo');
    const nuevoLat = urlParams.get('lat');
    const nuevoLng = urlParams.get('lng');
    
    if (nuevoReporteId && nuevoLat && nuevoLng) {
        // Centrar mapa en el nuevo reporte
        map.setView([parseFloat(nuevoLat), parseFloat(nuevoLng)], 16);
        
        // Buscar el marcador del nuevo reporte y abrir su popup
        setTimeout(function() {
            todosLosMarcadores.forEach(function(marker) {
                if (marker.reporteData && marker.reporteData.id == nuevoReporteId) {
                    marker.openPopup();
                    
                    // Animación de "ping"
                    const element = marker.getElement();
                    if (element) {
                        element.style.animation = 'ping 2s ease-out 3';
                    }
                }
            });
        }, 500);
        
        // Limpiar URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    //.
</script>
{% endblock %}


